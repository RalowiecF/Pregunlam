<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PregUNLaM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body class="w3-light-grey" style="display: flex; flex-direction: column; min-height: 100vh; margin: 0;">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<header class="w3-container w3-padding w3-card"
        style="background-image: url('{{BASE_URL}}imagenes/BannerFondo.png');
               background-size: cover;
               background-position: center;
               height: 100px; display: flex; align-items: center; justify-content: space-between;">

    <!-- IZQUIERDA: Bienvenida -->
    <div class="w3-text-white w3-large" style="margin-left: 10px;">
        {{#usuarioLogueado}}
            Bienvenido {{usuarioLogueado.nombreUsuario}} ({{usuarioLogueado.tipoUsuario}})
        {{/usuarioLogueado}}
        {{^usuarioLogueado}}
            Bienvenido Invitado
        {{/usuarioLogueado}}
    </div>

    <!-- CENTRO: Logo -->
    <div class="w3-center" style="flex-grow: 1;">
        <a href="{{BASE_URL}}"><img src="{{BASE_URL}}imagenes/IsologotipoApaisado.png"
             alt="Logo PregUNLaM"
             style="max-height: 180px; width: auto;"></a>
    </div>

    <!-- DERECHA: Controles -->
    <div class="w3-right-align" style="margin-right: 10px;">
        <!-- Botón de música -->
        <button class="w3-button w3-green w3-round"
                style="margin-right: 5px;"
                onclick="toggleMusic()">
            <i id="icon-music-on" class="fa-solid fa-music"></i>
            <i id="icon-music-off" class="fa-solid fa-music-slash" style="display:none;"></i>
            Música</button>

        <audio id="backgroundMusic" src="{{BASE_URL}}imagenes/musica/pregUnlam.mp3" loop style="display:none;"></audio>

        <!-- Si NO está logueado -->
        {{^usuarioLogueado}}
            <a class="w3-button w3-blue w3-round" href="{{BASE_URL}}usuario/login">Login</a>
        {{/usuarioLogueado}}

        <!-- Si está logueado -->
        {{#usuarioLogueado}}
            <div class="w3-dropdown-hover">
                <button class="w3-button w3-blue w3-round">Mi Cuenta ⮟</button>
                <div class="w3-dropdown-content w3-bar-block w3-card-4 w3-animate-opacity"
                     style="right:0; background-color: #f0f0f0;">
                    <a href="{{BASE_URL}}usuario/verPerfil/idUsuario={{usuarioLogueado.idUsuario}}" class="w3-bar-item w3-button"><i class="fa-solid fa-user"></i> Ver Perfil</a>
                    <a href="{{BASE_URL}}usuario/contactos" class="w3-bar-item w3-button"><i class="fa-solid fa-user"></i> Contactos</a>
                    <a href="{{BASE_URL}}usuario/logout" class="w3-bar-item w3-button w3-text-red"><i class="fa-solid fa-right-from-bracket" style="color: #d11010;"></i> Cerrar sesión</a>
                </div>
            </div>
        {{/usuarioLogueado}}
    </div>
</header>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Obtener idUsuario desde Mustache (o null si no hay usuario)
        var idUsuario = {{#usuarioLogueado}}{{usuarioLogueado.idUsuario}}{{/usuarioLogueado}}{{^usuarioLogueado}}null{{/usuarioLogueado}};
        var keyPrefix = 'music_' + (idUsuario !== null ? idUsuario : 'guest') + '_';

        var audio = document.getElementById('backgroundMusic');
        var savedTime = localStorage.getItem(keyPrefix + 'time');
        var wasPaused = localStorage.getItem(keyPrefix + 'paused') === 'true';

        if (savedTime) {
            audio.currentTime = parseFloat(savedTime);
        }

        if (!wasPaused) {
            audio.play().catch(function() {
                document.body.addEventListener('click', function playOnce() {
                    audio.play();
                    document.body.removeEventListener('click', playOnce);
                });
            });
        }

        audio.addEventListener('timeupdate', function() {
            localStorage.setItem(keyPrefix + 'time', audio.currentTime);
        });

        audio.addEventListener('play', function() {
            localStorage.setItem(keyPrefix + 'paused', 'false');
        });

        audio.addEventListener('pause', function() {
            localStorage.setItem(keyPrefix + 'paused', 'true');
        });

        var iconOn = document.getElementById('icon-music-on');
        var iconOff = document.getElementById('icon-music-off');

        function updateMusicIcon() {
            if (audio.paused) {
                iconOn.style.display = 'none';
                iconOff.style.display = '';
            } else {
                iconOn.style.display = '';
                iconOff.style.display = 'none';
            }
        }

        audio.addEventListener('play', updateMusicIcon);
        audio.addEventListener('pause', updateMusicIcon);

        // Llama una vez al cargar
        updateMusicIcon();
    });


    function toggleMusic() {
        var audio = document.getElementById('backgroundMusic');
        if (audio.paused) {
            audio.play();
        } else {
            audio.pause();
        }
    }
</script>